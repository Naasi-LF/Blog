---
title: "异常控制流程"
date: 2025-03-18T01:22:29+08:00
draft: true
description: "全面概述异常控制流程机制，涵盖异常、中断、陷阱、系统调用、错误和终止。"
tags: ["异常", "中断", "陷阱", "系统调用", "错误", "终止"]
categories: ["异常和中断"]
---

# 异常控制流程

## 控制流程

处理器只做一件事：

从启动到关机，每个 CPU 核心只是依次读取并执行（解释）指令，一次一条。

## 改变控制流程

- 跳转和分支
- 调用和返回

## 对于构建有用系统来说不足：难以对系统状态的变化做出响应

- 数据从磁盘或网络适配器到达
- 指令除以零
- 用户按下 Ctrl-C
- 系统定时器超时

> 系统需要“异常控制流程”的机制

## 异常

异常是对某个事件（即处理器状态变化）作出响应，将控制权转移到操作系统内核的过程。

- 内核是操作系统常驻内存的部分
- 事件例子：除零、算术溢出、页面错误、I/O 请求完成、按下 Ctrl-C

![image-20250317194307702](https://naasi.oss-cn-shanghai.aliyuncs.com/image-20250317194307702.png)

## 异常表

![image-20250317194209075](https://naasi.oss-cn-shanghai.aliyuncs.com/image-20250317194209075.png)

- 每种事件都有一个唯一的异常号 k
- k 是异常表（又称中断向量）的索引
- 每次异常 k 发生时，都会调用处理程序 k

**在系统启动时**（计算机重置或开机时），操作系统分配并**初始化一个跳转表**，称为异常表，使得索引 k 对应的项包含异常 k 的处理程序地址。异常号作为索引指向异常表，其起始地址存储在一个特殊的 CPU 寄存器中，即异常表基寄存器。

## 硬件异常控制流程分类

![image-20250317195112056](https://naasi.oss-cn-shanghai.aliyuncs.com/image-20250317195112056.png)

## 异步异常（中断）

### 由处理器外部事件引发

- 通过设置处理器的中断引脚进行指示
- 处理程序返回至“下一条”指令

### 例子

- 定时中断：每隔几毫秒，外部定时芯片触发中断，由内核重新从用户程序获取控制权
- 来自外部设备的 I/O 中断：键盘按下 Ctrl-C、网络收到数据包、磁盘数据到达

## 同步异常

由执行指令时所发生的事件引起：
### 陷阱
- 故意触发，程序设置陷阱进行某些操作
- 例子：系统调用、gdb 断点
- 返回至“下一条”指令

### 错误
- 非故意但可能可恢复的错误
- 例子：页面错误（可恢复）、保护错误（不可恢复）、浮点异常
- 要么重新执行出错（“当前”）指令，要么中止程序

### 终止
- 非故意且不可恢复
- 例子：非法指令、奇偶校验错误、机器检查
- 中止当前程序

## 系统调用

每个 x86-64 系统调用都有一个唯一的 ID 号

![image-20250318010540380](https://naasi.oss-cn-shanghai.aliyuncs.com/image-20250318010540380.png)

## 例子

### 系统调用示例：打开文件

![image-20250318011150096](https://naasi.oss-cn-shanghai.aliyuncs.com/image-20250318011150096.png)

几乎就像函数调用一样

- 转移控制权
- 返回时执行下一条指令
- 使用调用约定传递参数
- 在 %rax 中获取返回值

一个重要的例外！

- 由内核运行
- 权限级别不同
- 其他差异：例如，“函数”的地址存放在 %rax 中，并使用 errno 等机制

### 错误示例：页面错误

![image-20250318011229265](https://naasi.oss-cn-shanghai.aliyuncs.com/image-20250318011229265.png)

### 错误示例：非法内存引用

![image-20250318011250386](https://naasi.oss-cn-shanghai.aliyuncs.com/image-20250318011250386.png)

## 异常类别

| 类别   | 原因                         | 异步/同步 | 返回行为                          |
| ------ | ---------------------------- | --------- | --------------------------------- |
| 中断   | 来自 I/O 设备的信号           | 异步      | 始终返回下一条指令                 |
| 陷阱   | 故意引发的异常               | 同步      | 始终返回下一条指令                 |
| 错误   | 潜在可恢复的错误              | 同步      | 可能返回当前指令                   |
| 终止   | 不可恢复的错误              | 同步      | 永不返回                           |

![image-20250318011704471](https://naasi.oss-cn-shanghai.aliyuncs.com/image-20250318011704471.png)

![image-20250318011725837](https://naasi.oss-cn-shanghai.aliyuncs.com/image-20250318011725837.png)